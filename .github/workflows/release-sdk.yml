name: Add SDK assets to release

on:
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      release:
        description: The release (tag name) to add the SDK assets to
        required: true

jobs:
  context:
    permissions: {}
    runs-on: ubuntu-latest
    outputs:
      release-name: ${{ steps.release.outputs.tag }}
      swift-version: ${{ steps.release.outputs.tag }}
    steps:
      - name: Determine Release
        id: release
        env:
          TRIGGER: ${{ github.event_name }}
          RELEASE_INPUT: ${{ github.event.inputs.release }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          if [ "${TRIGGER}" = 'workflow_dispatch' ]; then
            echo "tag=${RELEASE_INPUT}" >> "${GITHUB_OUTPUT}"
          else
            echo "tag=${REF_NAME}" >> "${GITHUB_OUTPUT}"
          fi

  build-sdk:
    needs: context
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        host-os:
          - 'macos'
        host-os-version:
          - '13'
        host-arch:
          - 'x86_64'
          - 'arm64'
        target-arch:
          - 'x86_64'
          - 'arm64'
        target-os:
          - 'ubuntu'
        target-os-version:
          - '22.04'
    runs-on: ${{ matrix.host-os }}-${{ matrix.host-os-version }}
    steps:
      - uses: ffried/swift-cross-compilation-sdk-bundles/actions/bundle-name@main
        id: bundle-names
        with:
          swift-version: ${{ needs.context.outputs.swift-version }}
          host-os: ${{ matrix.host-os }}
          host-os-version: ${{ matrix.host-os-version }}
          host-arch: ${{ matrix.host-arch }}
          target-os: ${{ matrix.target-os }}
          target-os-version: ${{ matrix.target-os-version }}
          target-arch: ${{ matrix.target-arch }}
      - name: Check for existing asset
        id: existing-asset
        env:
          REPO: ${{ github.repository }}
          RELEASE_NAME: ${{ needs.context.outputs.release-name }}
          ASSET_NAME: ${{ steps.bundle-names.outputs.full-name }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FOUND="$(gh release view --repo "${REPO}" "${RELEASE_NAME}" --json assets --jq ".assets | map(.label) | contains([\"${ASSET_NAME}\"])")"
          echo "found=${FOUND}" >> "${GITHUB_OUTPUT}"
      - uses: ffried/swift-cross-compilation-sdk-bundles/actions/generate-cross-compilation-sdk@main
        if: ${{ steps.existing-asset.outputs.found != 'true' }}
        id: generate-sdk
        with:
          swift-version: ${{ needs.context.outputs.swift-version }}
          host-os: ${{ matrix.host-os }}
          host-os-version: ${{ matrix.host-os-version }}
          host-arch: ${{ matrix.host-arch }}
          target-os: ${{ matrix.target-os }}
          target-os-version: ${{ matrix.target-os-version }}
          target-arch: ${{ matrix.target-arch }}
      - name: Upload asset
        if: ${{ steps.existing-asset.outputs.found != 'true' }}
        env:
          REPO: ${{ github.repository }}
          RELEASE_NAME: ${{ needs.context.outputs.release-name }}
          ASSET_PATH: ${{ steps.generate-sdk.outputs.bundle-package-path }}
          ASSET_NAME: ${{ steps.bundle-names.outputs.full-name }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload --repo "${REPO}" --clobber "${RELEASE_NAME}" "${ASSET_PATH}#${ASSET_NAME}"
